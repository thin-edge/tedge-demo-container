# child device templates
x-child-agent: &child-container
  build:
      context: ".."
      dockerfile: child-device-container/child.dockerfile
  restart: always
  tmpfs:
    - /tmp
  networks:
    - tedge

x-child-defaults: &child-device-systemd
  build:
      context: ".."
      dockerfile: child-device-systemd/child.dockerfile
  restart: always
  privileged: true
  networks:
    - tedge

services:
  tedge:
    build:
      context: ".."
      dockerfile: debian-systemd/debian-systemd.dockerfile
    environment:
      - DEVICE_ID=${DEVICE_ID:-}
      - C8Y_BASEURL=${C8Y_BASEURL:-}
      - C8Y_USER=${C8Y_USER:-}
    volumes:
      - etc:/etc

      # Enable docker from docker - But then this container has elevated access to system resources!
      - /var/run/docker.sock:${DOCKER_SOCKET:-/var/run/docker.sock}:rw

    restart: always
    privileged: true
    hostname: tedge
    networks:
      - tedge

  # child devices
  child01:
    <<: *child-container
    environment:
      - TEDGE_MQTT_DEVICE_TOPIC_ID=device/child01//
    hostname: child01
    volumes:
      - child01_etc:/etc
      - child01_logs:/var/log/tedge

  child02:
    <<: *child-device-systemd
    hostname: child02
    volumes:
      - child02_etc:/etc
      - child02_logs:/var/log/tedge

volumes:
  etc:
  child01_etc:
  child01_logs:
  child02_etc:
  child02_logs:

networks:
  tedge:
